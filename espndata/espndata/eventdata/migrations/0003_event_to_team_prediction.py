# Generated by Django 5.2.6 on 2025-09-25 05:03
""" 
Data migration to shift from Event model only structure to
new Event + TeamPrediction models structure.
"""
from django.db import migrations

from tqdm import tqdm

def forward(apps, schema_editor):
    _Event = apps.get_model('eventdata', 'Event')
    _TeamPrediction = apps.get_model('eventdata', 'TeamPrediction')

    for event in tqdm(_Event.objects.all(), desc='Migrating Event Data'):
        home_team_prediction = _TeamPrediction.objects.create(
            event=event,
            team_name=event.home_team,
            team_rank=event.home_rank,
            home_away='home' if not event.is_neutral_site else 'neutral',
            win_probability=event.home_win_probability,
            moneyline=event.home_moneyline,
            is_winner=event.is_home_win,
            opponent_name=event.away_team,
            opponent_rank=event.away_rank,
        )
        away_team_prediction = _TeamPrediction.objects.create(
            event=event,
            team_name=event.away_team,
            team_rank=event.away_rank,
            home_away='away' if not event.is_neutral_site else 'neutral',
            win_probability=event.away_win_probability,
            moneyline=event.away_moneyline,
            is_winner=event.is_away_win,
            opponent_name=event.home_team,
            opponent_rank=event.home_rank,
        )

        if home_team_prediction.is_winner:
            event.winning_team = home_team_prediction.team_name
        elif away_team_prediction.is_winner:
            event.winning_team = away_team_prediction.team_name

        event.save()

def backward(apps, schema_editor):
    pass

class Migration(migrations.Migration):
    dependencies = [
        ('eventdata', '0002_alter_event_options_event_winning_team_and_more'),
    ]

    operations = [
        migrations.RunPython(forward, backward)
    ]
